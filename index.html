<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNCI - Hub de Bienestar y Trayectorias</title>
    
    <!-- Configuración de seguridad para imágenes -->
    <script>
        window.handleImageError = function(img) {
            img.onerror = null;
            // Placeholder gris claro para modo light
            img.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMDAiIGhlaWdodD0iMjAwIiB2aWV3Qm94PSIwIDAgMzAwIDIwMCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iI2Y1ZjVZjUiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iI2NjYyIgZm9udC1zaXplPSIyMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiPlNpbiBJbWFnZW48L3RleHQ+PC9zdmc+';
        };
        
        window.toggleNotifications = function() {
            const dd = document.getElementById('notification-dropdown');
            const badge = document.getElementById('notif-badge');
            if(dd.classList.contains('hidden')) { 
                if(typeof renderNotifications === 'function') renderNotifications(); 
                dd.classList.remove('hidden'); 
                badge.classList.add('hidden');
            } else { 
                dd.classList.add('hidden'); 
            }
        };

        window.getEmbedUrl = function(input) {
            if (!input) return '';
            input = input.trim();
            if (input.includes('<iframe')) { const match = input.match(/src="([^"]+)"/); return match ? match[1] : ''; }
            if (input.includes('youtube.com/embed/')) return input;
            if (input.includes('v=')) { const videoId = input.split('v=')[1].split('&')[0]; return `https://www.youtube.com/embed/${videoId}`; }
            if (input.includes('youtu.be/')) { const videoId = input.split('youtu.be/')[1].split('?')[0]; return `https://www.youtube.com/embed/${videoId}`; }
            if (input.length > 5 && !input.includes('/') && !input.includes('.')) { const cleanId = input.split('?')[0]; return `https://www.youtube.com/embed/${cleanId}`; }
            return input;
        };
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Roboto:wght@300;400;500&display=swap');
        
        :root {
            --primary-blue: #2a6aff;
            --accent-orange: #ff8500;
            --bg-light: #f8fafc; /* Gris muy suave */
            --bg-white: #ffffff;
            --text-dark: #1f2937;
        }

        body { 
            font-family: 'Roboto', sans-serif; 
            background-color: var(--bg-light); 
            color: var(--text-dark); 
            overflow-x: hidden; 
        }

        h1, h2, h3, h4, h5, .font-heading {
            font-family: 'Montserrat', sans-serif;
        }
        
        /* Scrollbar styling for light theme */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #e5e7eb; }
        ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        .hide-scroll-bar::-webkit-scrollbar { display: none; }
        .hide-scroll-bar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Card Styles */
        .movie-card {
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            background: white;
            border: 1px solid #f3f4f6;
        }
        .movie-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(42, 106, 255, 0.2), 0 4px 6px -2px rgba(42, 106, 255, 0.1);
            border-color: var(--primary-blue);
        }

        /* Hero */
        .hero-gradient { background: linear-gradient(to top, #f8fafc 5%, transparent 90%); }
        .hero-overlay { background: linear-gradient(77deg, rgba(0,0,0,0.6), transparent 85%); }

        /* Utils */
        .text-cnci-blue { color: var(--primary-blue); }
        .bg-cnci-blue { background-color: var(--primary-blue); }
        .text-cnci-orange { color: var(--accent-orange); }
        .bg-cnci-orange { background-color: var(--accent-orange); }
        
        .live-indicator { animation: pulse-red 2s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(255, 133, 0, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(255, 133, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 133, 0, 0); } }

        .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; background: #000; border-radius: 0.5rem; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
        
        .time-chip { font-size: 0.7rem; background: #e5e7eb; color: #374151; padding: 2px 8px; border-radius: 999px; cursor: pointer; border: 1px solid #d1d5db; }
        .time-chip:hover { background: #2a6aff; color: white; border-color: #2a6aff; }

        .star-rating { direction: rtl; display: inline-flex; }
        .star-rating input { display: none; }
        .star-rating label { color: #d1d5db; font-size: 1.5rem; padding: 0 2px; cursor: pointer; transition: color 0.2s; }
        .star-rating input:checked ~ label, .star-rating label:hover, .star-rating label:hover ~ label { color: #fbbf24; }

        /* Calendar Light Theme */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: #e5e7eb; border: 1px solid #e5e7eb; }
        .calendar-header { background-color: #f3f4f6; padding: 10px; text-align: center; font-weight: 700; font-size: 0.8rem; text-transform: uppercase; color: #4b5563; }
        .calendar-day { background-color: white; min-height: 100px; padding: 8px; transition: background 0.2s; position: relative; }
        .calendar-day:hover { background-color: #f9fafb; }
        .calendar-day.empty { background-color: #f9fafb; }
        .day-number { font-weight: 600; font-size: 0.9rem; margin-bottom: 4px; display: block; color: #374151; }
        .calendar-event { font-size: 0.7rem; padding: 3px 6px; margin-bottom: 3px; border-radius: 4px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; transition: transform 0.1s; font-weight: 500; }
        .calendar-event:hover { transform: scale(1.02); z-index: 10; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        #loading-overlay { position: fixed; inset: 0; background: #ffffff; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s ease; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="loading-overlay">
        <div class="flex flex-col items-center">
            <i class="fas fa-graduation-cap text-6xl text-cnci-blue mb-4 animate-bounce"></i>
            <p class="text-gray-500 text-sm font-semibold tracking-wide">CARGANDO PLATAFORMA...</p>
        </div>
    </div>

    <!-- Navbar Light -->
    <nav class="fixed w-full z-50 transition-all duration-300 bg-white/95 backdrop-blur-md shadow-sm border-b border-gray-100" id="navbar">
        <div class="px-4 md:px-12 py-3 flex flex-col md:flex-row items-center justify-between gap-4">
            <div class="flex items-center justify-between w-full md:w-auto gap-8">
                <a href="#" class="flex items-center gap-3 group">
                    <img id="nav-logo" src="https://i.ibb.co/m5QcyKWg/Logo-CNCI.png" class="h-10 md:h-12 object-contain transition group-hover:opacity-80" alt="CNCI" onerror="handleImageError(this)">
                </a>
                
                <div class="hidden md:flex gap-6 text-sm font-medium text-gray-600">
                    <a href="#" class="hover:text-cnci-blue transition border-b-2 border-transparent hover:border-cnci-blue pb-1">Inicio</a>
                    <a href="#recordings-anchor" class="hover:text-cnci-blue transition border-b-2 border-transparent hover:border-cnci-blue pb-1">Biblioteca</a>
                    <a href="javascript:void(0)" onclick="openAboutModal()" class="text-cnci-orange hover:text-orange-600 transition flex items-center font-bold">
                        <i class="fas fa-info-circle mr-1.5"></i> ¿Qué son las Trayectorias?
                    </a>
                </div>
            </div>

            <div class="flex items-center gap-6 w-full md:w-auto justify-end">
                <div class="relative group w-full md:w-64">
                    <input type="text" id="global-search" onkeyup="handleGlobalSearch(this.value)" placeholder="Buscar sesión..." class="bg-gray-100 border border-gray-200 rounded-full px-4 py-2 text-sm text-gray-700 focus:border-cnci-blue focus:bg-white focus:outline-none w-full transition-all shadow-inner">
                    <i class="fas fa-search absolute right-3 top-2.5 text-gray-400 pointer-events-none"></i>
                </div>
                
                <div class="relative">
                    <div class="relative p-2 rounded-full hover:bg-gray-100 transition cursor-pointer" onclick="toggleNotifications()">
                        <i class="far fa-bell text-gray-600 text-xl"></i>
                        <span id="notif-badge" class="absolute top-1 right-1 bg-cnci-orange text-white text-[9px] font-bold w-4 h-4 flex items-center justify-center rounded-full border-2 border-white hidden"></span>
                    </div>
                    <div id="notification-dropdown" class="absolute top-12 right-0 bg-white border border-gray-100 rounded-xl shadow-xl w-80 hidden flex-col z-50 max-h-96 overflow-y-auto">
                        <div class="p-3 border-b border-gray-100 font-bold text-sm text-gray-800 bg-gray-50 rounded-t-xl">Avisos Recientes</div>
                        <div id="notif-list" class="flex flex-col"><div class="p-4 text-center text-gray-400 text-xs">No tienes notificaciones.</div></div>
                    </div>
                </div>

                <div class="flex items-center gap-3 cursor-pointer group relative p-1 rounded-full hover:bg-gray-50 transition pr-3" onclick="handleProfileClick()">
                    <img id="user-avatar" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class="w-9 h-9 rounded-full border border-gray-200 object-cover" onerror="handleImageError(this)">
                    <i class="fas fa-chevron-down text-gray-400 text-xs group-hover:text-cnci-blue transition"></i>
                    <div id="profile-dropdown" class="absolute top-12 right-0 bg-white border border-gray-100 rounded-xl shadow-xl w-56 hidden flex-col py-2 z-50">
                        <div class="px-4 py-3 border-b border-gray-100"><span class="block text-xs text-gray-400 uppercase font-bold tracking-wider">Conectado como</span><span id="user-greeting" class="text-sm font-bold text-cnci-blue truncate block">Invitado</span></div>
                        <a href="javascript:void(0)" onclick="openPathwaysModal()" class="px-4 py-2.5 hover:bg-gray-50 text-sm text-gray-700 flex items-center gap-2"><i class="far fa-user-circle text-gray-400"></i> Mi Perfil</a>
                        <a href="javascript:void(0)" onclick="logout()" class="px-4 py-2.5 hover:bg-red-50 text-sm text-red-600 flex items-center gap-2 border-t border-gray-100"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <div class="relative h-[70vh] md:h-[80vh] w-full bg-gray-900" id="hero-section"></div>

    <!-- Filters (Trayectorias) -->
    <div class="relative z-10 -mt-8 px-4 md:px-12 mb-12">
        <div class="bg-white rounded-xl shadow-lg p-4 md:flex items-center justify-between gap-4 border border-gray-100">
            <h3 class="text-gray-500 text-xs font-bold uppercase tracking-widest mb-3 md:mb-0 md:mr-4 shrink-0"><i class="fas fa-filter text-cnci-blue mr-1"></i> Filtrar por:</h3>
            <div class="flex flex-wrap gap-2" id="pathway-filters"></div>
        </div>
    </div>

    <!-- Main Content (Rows) -->
    <div class="relative z-10 pb-16 space-y-12 px-4 md:px-12 min-h-[30vh]" id="content-rows"></div>
    
    <!-- CALENDAR SECTION -->
    <div id="calendar-anchor" class="py-16 px-4 md:px-12 bg-white border-t border-gray-100">
        <div class="max-w-7xl mx-auto">
            <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                <div><h2 class="text-2xl font-heading font-bold text-gray-800"><i class="far fa-calendar-alt text-cnci-blue mr-2"></i> Calendario Académico</h2><p class="text-sm text-gray-500 mt-1">Planifica tu asistencia a las próximas sesiones.</p></div>
                <div class="flex gap-2"><select id="cal-filter-cat" onchange="renderCalendar()" class="bg-gray-50 border border-gray-300 text-gray-700 rounded-lg px-3 py-2 text-sm focus:border-cnci-blue outline-none"><option value="all">Todas Trayectorias</option></select><select id="cal-filter-sec" onchange="renderCalendar()" class="bg-gray-50 border border-gray-300 text-gray-700 rounded-lg px-3 py-2 text-sm focus:border-cnci-blue outline-none"><option value="all">Todas Secciones</option></select></div>
            </div>
            <div class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden">
                <div class="flex justify-between items-center p-4 bg-gray-50 border-b border-gray-200"><button onclick="changeMonth(-1)" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 text-gray-600"><i class="fas fa-chevron-left"></i></button><h3 id="cal-month-year" class="text-lg font-bold text-cnci-blue uppercase tracking-wide"></h3><button onclick="changeMonth(1)" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 text-gray-600"><i class="fas fa-chevron-right"></i></button></div>
                <div class="calendar-grid"><div class="calendar-header">Dom</div><div class="calendar-header">Lun</div><div class="calendar-header">Mar</div><div class="calendar-header">Mié</div><div class="calendar-header">Jue</div><div class="calendar-header">Vie</div><div class="calendar-header">Sáb</div></div>
                <div id="calendar-days" class="calendar-grid"></div>
            </div>
        </div>
    </div>

    <!-- Recordings (Library) -->
    <div id="recordings-anchor" class="py-16 px-4 md:px-12 bg-gray-50 border-t border-gray-200">
        <div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-4">
            <div><h2 class="text-3xl font-heading font-bold text-gray-800 mb-2"><i class="fas fa-play-circle text-cnci-blue mr-2"></i>Biblioteca de Sesiones</h2><p class="text-gray-500">Accede al archivo histórico y ponte al día con tus trayectorias.</p></div>
            <div class="w-full md:w-auto"><select id="recordings-filter" onchange="renderRecordingsGrid()" class="bg-white border border-gray-300 text-gray-700 rounded-lg px-4 py-2 focus:border-cnci-blue outline-none w-full md:w-64 shadow-sm"><option value="all">Todas las Trayectorias</option></select></div>
        </div>
        <div id="recordings-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6"></div>
    </div>

    <footer class="bg-white py-12 px-12 text-gray-500 text-sm border-t border-gray-200">
        <div class="flex flex-col items-center justify-center gap-4"><img id="footer-logo" src="https://i.ibb.co/m5QcyKWg/Logo-CNCI.png" class="h-8 opacity-50 grayscale hover:grayscale-0 transition" onerror="handleImageError(this)"><p>© 2026 Universidad Virtual CNCI. Todos los derechos reservados.</p><button onclick="openAdminModal()" class="text-xs text-gray-400 hover:text-cnci-orange transition mt-2 flex items-center gap-1"><i class="fas fa-lock"></i> Acceso Administrativo</button></div>
    </footer>

    <!-- MODAL "QUÉ SON LAS TRAYECTORIAS" -->
    <div id="about-modal" class="fixed inset-0 z-[110] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl max-w-4xl w-full shadow-2xl relative flex flex-col max-h-[90vh] overflow-hidden">
            <div class="bg-gradient-to-r from-cnci-orange to-orange-600 p-6 relative flex-shrink-0">
                <button onclick="document.getElementById('about-modal').classList.add('hidden')" class="absolute top-4 right-4 text-white/80 hover:text-white transition"><i class="fas fa-times text-2xl"></i></button>
                <h2 class="text-2xl font-bold text-white mb-1 font-heading"><i class="fas fa-road mr-2"></i>Tu Camino al Éxito</h2>
                <p class="text-orange-100 text-sm">Entiende cómo funcionan nuestras trayectorias de bienestar.</p>
            </div>
            <div class="p-8 overflow-y-auto">
                <div class="video-container mb-8 rounded-xl overflow-hidden shadow-lg"><iframe id="about-video-frame" src="" allowfullscreen></iframe></div>
                <div id="about-text-content" class="prose max-w-none text-gray-600 leading-relaxed text-sm">Cargando información...</div>
            </div>
        </div>
    </div>

    <!-- MODAL DETALLES VIDEO -->
    <div id="modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 transition-opacity duration-300 opacity-0">
        <div class="bg-white w-full max-w-5xl rounded-2xl overflow-hidden shadow-2xl relative transform transition-transform duration-300 scale-95 border border-gray-100 flex flex-col max-h-[90vh]" id="modal-content">
            <button onclick="closeModal()" class="absolute top-4 right-4 z-20 bg-white/80 rounded-full p-2 text-gray-800 hover:bg-cnci-blue hover:text-white transition shadow-sm"><i class="fas fa-times w-5 h-5 flex items-center justify-center"></i></button>
            <div id="modal-embed-container" class="hidden w-full bg-black shrink-0"><div class="video-container"><iframe id="modal-iframe" src="" allowfullscreen></iframe></div></div>
            <div id="modal-hero-container" class="relative h-64 md:h-[350px] shrink-0">
                <img id="modal-img" src="" class="w-full h-full object-cover" onerror="handleImageError(this)">
                <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent"></div>
                <div class="absolute bottom-0 left-0 right-0 p-8">
                    <h2 id="modal-title" class="text-3xl md:text-4xl font-bold text-white mb-2 font-heading shadow-sm">Title</h2>
                    <div class="flex items-center gap-4 text-sm mb-4"><span id="modal-match" class="text-green-400 font-bold bg-black/40 px-2 py-0.5 rounded backdrop-blur-sm"></span><span class="text-gray-200" id="modal-time-status"></span><span class="text-yellow-400 text-sm ml-2 bg-black/40 px-2 py-0.5 rounded backdrop-blur-sm" id="modal-avg-rating"></span></div>
                     <div class="flex gap-3">
                        <a id="modal-link-btn" href="#" target="_blank" class="bg-cnci-blue text-white px-6 py-2.5 rounded-lg font-bold hover:bg-blue-700 flex items-center gap-2 transition shadow-lg hover:shadow-blue-500/30"><i class="fas fa-external-link-alt"></i> Ingresar</a>
                        <a id="modal-gcal-btn" href="#" target="_blank" class="bg-white/20 backdrop-blur-md text-white border border-white/30 px-4 py-2.5 rounded-lg font-bold hover:bg-white hover:text-black flex items-center gap-2 transition"><i class="far fa-calendar-plus"></i> Agendar</a>
                        <button id="btn-favorite" onclick="toggleFavorite()" class="bg-white/20 backdrop-blur-md text-white border border-white/30 px-4 py-2.5 rounded-lg hover:bg-white hover:text-pink-600 transition tooltip-btn" title="Añadir a mi lista"><i class="far fa-heart"></i></button>
                    </div>
                </div>
            </div>
            <div class="p-8 grid md:grid-cols-3 gap-8 overflow-y-auto bg-white">
                <div class="md:col-span-2 space-y-6">
                    <div class="flex justify-between items-start"><h2 id="modal-title-alt" class="text-2xl font-bold text-gray-800 hidden font-heading"></h2><div id="modal-rating-container" class="hidden"><p class="text-xs text-gray-500 mb-1 font-bold uppercase">Califica esta sesión:</p><div class="star-rating"><input type="radio" id="star5" name="rating" value="5" onclick="rateSession(5)"><label for="star5">★</label><input type="radio" id="star4" name="rating" value="4" onclick="rateSession(4)"><label for="star4">★</label><input type="radio" id="star3" name="rating" value="3" onclick="rateSession(3)"><label for="star3">★</label><input type="radio" id="star2" name="rating" value="2" onclick="rateSession(2)"><label for="star2">★</label><input type="radio" id="star1" name="rating" value="1" onclick="rateSession(1)"><label for="star1">★</label></div></div></div>
                    <div><h4 class="text-sm font-bold text-gray-400 uppercase tracking-wide mb-2">Descripción</h4><p id="modal-desc" class="text-gray-600 leading-relaxed">Description...</p></div>
                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 flex gap-4"><div class="text-2xl text-cnci-blue"><i class="fas fa-certificate"></i></div><div><p class="text-cnci-blue text-sm font-bold mb-1">Progreso de Constancia</p><p class="text-gray-600 text-xs">Esta sesión cuenta para la insignia: <span id="modal-pathway-name" class="font-bold text-gray-800">General</span>.</p></div></div>
                </div>
                <div class="text-sm space-y-4 text-gray-600 border-l border-gray-100 pl-0 md:pl-8">
                    <div><span class="block text-xs font-bold text-gray-400 uppercase mb-1">Ponente</span> <span id="modal-speaker" class="font-medium text-gray-800">Name</span></div>
                    <div><span class="block text-xs font-bold text-gray-400 uppercase mb-1">Categoría</span> <span id="modal-category" class="inline-block bg-gray-100 px-2 py-1 rounded text-xs font-bold text-gray-600">Category</span></div>
                    <div><span class="block text-xs font-bold text-gray-400 uppercase mb-1">Horario (CDMX)</span> <span id="modal-duration" class="font-medium text-gray-800">Time</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL PERFIL -->
    <div id="pathways-modal" class="fixed inset-0 z-[105] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl max-w-4xl w-full shadow-2xl relative overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-gradient-to-r from-cnci-blue to-blue-700 p-6 relative flex-shrink-0">
                <button onclick="document.getElementById('pathways-modal').classList.add('hidden')" class="absolute top-4 right-4 text-white/70 hover:text-white transition"><i class="fas fa-times text-xl"></i></button>
                <h2 class="text-2xl font-bold text-white mb-1 font-heading"><i class="fas fa-id-card mr-2"></i>Mi Portal del Alumno</h2>
                <p class="text-blue-100 text-sm">Gestiona tus constancias, progreso y lista de interés.</p>
            </div>
            <div class="flex-1 overflow-y-auto p-8 space-y-10 bg-gray-50">
                <div class="flex items-center gap-5 bg-white p-6 rounded-xl shadow-sm border border-gray-100"><img id="profile-modal-avatar" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class="w-20 h-20 rounded-full border-4 border-white shadow-md" onerror="handleImageError(this)"><div><h3 id="profile-modal-id" class="text-2xl font-bold text-gray-800 font-heading"></h3><p class="text-sm text-gray-500 font-medium">Estudiante Activo • Universidad CNCI</p></div></div>
                <div><h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center"><i class="fas fa-heart text-pink-500 mr-2"></i>Mi Lista de Interés</h3><div id="favorites-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div></div>
                <div><h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center"><i class="fas fa-trophy text-yellow-500 mr-2"></i>Progreso de Trayectorias</h3><div id="pathways-container" class="grid gap-4"></div></div>
            </div>
        </div>
    </div>

    <!-- LOGIN MODAL -->
    <div id="login-modal" class="fixed inset-0 z-[110] hidden flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="bg-white p-8 rounded-2xl max-w-md w-full shadow-2xl relative border-t-4 border-cnci-blue">
            <button onclick="document.getElementById('login-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-cnci-blue transition"><i class="fas fa-times text-xl"></i></button>
            <div class="text-center mb-6"><img src="https://i.ibb.co/m5QcyKWg/Logo-CNCI.png" class="h-12 mx-auto mb-4" onerror="handleImageError(this)"><h2 class="text-2xl font-bold text-gray-800 font-heading">Bienvenido</h2><p class="text-gray-500 text-sm">Ingresa tus credenciales institucionales</p></div>
            <div class="space-y-4 text-left">
                <div><label class="text-xs font-bold text-gray-500 uppercase ml-1">Matrícula</label><input type="text" id="student-id" placeholder="Ej. AL065839" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-3 text-gray-800 focus:border-cnci-blue focus:ring-2 focus:ring-blue-100 outline-none transition uppercase font-bold"></div>
                <div><label class="text-xs font-bold text-gray-500 uppercase ml-1">Contraseña</label><input type="password" id="student-pass" placeholder="••••••" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-3 text-gray-800 focus:border-cnci-blue focus:ring-2 focus:ring-blue-100 outline-none transition"></div>
                <button onclick="attemptLogin()" class="w-full bg-cnci-blue hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition shadow-lg shadow-blue-500/30">Acceder al Hub</button>
                <p class="text-center text-xs text-gray-400 mt-4">¿Primera vez? Ingresa tu matrícula y crea una contraseña.</p>
            </div>
        </div>
    </div>

    <!-- ADMIN MODAL -->
    <div id="admin-modal" class="fixed inset-0 z-[120] hidden flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
        <div class="bg-gray-50 rounded-2xl max-w-[95vw] w-full h-[95vh] flex flex-col overflow-hidden relative shadow-2xl border border-gray-200">
            <div id="admin-login-view" class="flex flex-col items-center justify-center h-full p-8 bg-white">
                <div class="bg-gray-100 p-4 rounded-full mb-4"><i class="fas fa-user-shield text-4xl text-cnci-orange"></i></div>
                <h2 class="text-2xl font-bold text-gray-800 mb-6 font-heading">Panel Administrativo</h2>
                <input type="password" id="admin-pass" placeholder="Contraseña de Acceso" class="bg-white border border-gray-300 rounded-lg p-3 text-gray-800 focus:border-cnci-orange outline-none mb-4 w-64 text-center">
                <button onclick="verifyAdmin()" class="bg-cnci-orange text-white font-bold px-8 py-2.5 rounded-lg hover:bg-orange-600 transition shadow-md">Entrar</button>
                <button onclick="closeAdminModal()" class="mt-6 text-sm text-gray-400 hover:text-gray-600 underline">Volver al sitio</button>
            </div>
            <div id="admin-dashboard-view" class="hidden flex h-full">
                <!-- Sidebar -->
                <div class="w-64 bg-white border-r border-gray-200 p-6 flex flex-col gap-2 overflow-y-auto shrink-0 shadow-sm z-10">
                    <h3 class="text-gray-400 font-bold text-xs uppercase tracking-widest mb-4 ml-2">Gestión</h3>
                    <button onclick="showAdminTab('stats')" id="tab-btn-stats" class="admin-tab-btn text-left text-gray-600 hover:bg-gray-50 hover:text-cnci-blue p-2.5 rounded-lg transition text-sm font-medium flex items-center gap-3"><i class="fas fa-chart-pie w-5"></i> Estadísticas</button>
                    <button onclick="showAdminTab('config')" id="tab-btn-config" class="admin-tab-btn text-left text-gray-600 hover:bg-gray-50 hover:text-cnci-blue p-2.5 rounded-lg transition text-sm font-medium flex items-center gap-3"><i class="fas fa-cogs w-5"></i> Config. General</button>
                    <button onclick="showAdminTab('sections')" id="tab-btn-sections" class="admin-tab-btn text-left text-gray-600 hover:bg-gray-50 hover:text-cnci-blue p-2.5 rounded-lg transition text-sm font-medium flex items-center gap-3"><i class="fas fa-layer-group w-5"></i> Secciones Home</button>
                    <button onclick="showAdminTab('sessions')" id="tab-btn-sessions" class="admin-tab-btn text-left text-gray-600 hover:bg-gray-50 hover:text-cnci-blue p-2.5 rounded-lg transition text-sm font-medium flex items-center gap-3"><i class="fas fa-video w-5"></i> Sesiones</button>
                    <button onclick="showAdminTab('pathways')" id="tab-btn-pathways" class="admin-tab-btn text-left text-gray-600 hover:bg-gray-50 hover:text-cnci-blue p-2.5 rounded-lg transition text-sm font-medium flex items-center gap-3"><i class="fas fa-map-signs w-5"></i> Trayectorias</button>
                    <div class="my-2 border-t border-gray-100"></div>
                    <h3 class="text-gray-400 font-bold text-xs uppercase tracking-widest mb-2 ml-2">Académico</h3>
                    <button onclick="showAdminTab('users')" id="tab-btn-users" class="admin-tab-btn text-left text-gray-600 hover:bg-gray-50 hover:text-cnci-blue p-2.5 rounded-lg transition text-sm font-medium flex items-center gap-3"><i class="fas fa-users w-5"></i> Alumnos</button>
                    <button onclick="showAdminTab('attendance')" id="tab-btn-attendance" class="admin-tab-btn text-left text-gray-600 hover:bg-gray-50 hover:text-cnci-blue p-2.5 rounded-lg transition text-sm font-medium flex items-center gap-3"><i class="fas fa-check-double w-5"></i> Asistencias</button>
                    <button onclick="showAdminTab('certificates')" id="tab-btn-certificates" class="admin-tab-btn text-left text-gray-600 hover:text-white p-2.5 rounded-lg transition text-sm font-medium flex items-center gap-3"><i class="fas fa-award w-5"></i> Constancias</button>
                    <div class="mt-auto pt-4"><button onclick="closeAdminModal()" class="text-left text-red-500 hover:bg-red-50 p-2.5 rounded-lg w-full transition text-sm font-bold flex items-center gap-3"><i class="fas fa-sign-out-alt w-5"></i> Salir</button></div>
                </div>
                
                <div id="admin-content-config" class="hidden flex-1 p-8 overflow-y-auto bg-gray-50">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 font-heading">Configuración del Sitio</h2>
                    <div class="grid gap-6 max-w-3xl">
                        <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                            <h3 class="text-lg font-bold text-cnci-blue mb-4">Identidad Visual</h3>
                            <div><label class="text-xs font-bold text-gray-500 uppercase block mb-1">URL del Logo (Navbar)</label><input type="text" id="conf-logo-url" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2.5 text-gray-800 text-sm focus:border-cnci-blue outline-none"><p class="text-[10px] text-gray-400 mt-1">Recomendado: PNG transparente.</p></div>
                        </div>
                        <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                            <h3 class="text-lg font-bold text-cnci-orange mb-4">Modal: ¿Qué son las Trayectorias?</h3>
                            <div class="space-y-4"><div><label class="text-xs font-bold text-gray-500 uppercase block mb-1">Video (YouTube)</label><input type="text" id="conf-about-video" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2.5 text-gray-800 text-sm focus:border-cnci-blue outline-none"></div><div><label class="text-xs font-bold text-gray-500 uppercase block mb-1">Texto Explicativo</label><textarea id="conf-about-text" rows="6" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2.5 text-gray-800 text-sm focus:border-cnci-blue outline-none"></textarea></div></div>
                        </div>
                        <button onclick="saveSiteConfig()" class="bg-green-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-500 shadow-md transition self-start">Guardar Toda la Configuración</button>
                    </div>
                </div>

                <div id="admin-content-stats" class="flex-1 p-8 overflow-y-auto bg-gray-50">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 font-heading">Estadísticas</h2>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm"><div class="flex justify-between mb-4"><h3 class="text-sm font-bold text-gray-500 uppercase">Top Sesiones</h3><select id="stats-chart-type" onchange="renderAdminStats()" class="bg-gray-100 border border-gray-300 text-xs rounded-lg text-gray-700 p-1 outline-none"><option value="attendance">Por Asistencia</option><option value="rating">Por Calificación</option></select></div><canvas id="chart-top-sessions"></canvas></div>
                        <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm"><h3 class="text-sm font-bold text-gray-500 uppercase mb-4">Preferencia por Trayectoria</h3><div class="w-2/3 mx-auto"><canvas id="chart-pathways"></canvas></div></div>
                        <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm col-span-full"><h3 class="text-sm font-bold text-gray-500 uppercase mb-4">Evolución Mensual</h3><canvas id="chart-attendance-month"></canvas></div>
                    </div>
                </div>
                
                <div id="admin-content-sessions" class="hidden flex-1 p-8 overflow-y-auto bg-gray-50">
                    <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-gray-800 font-heading">Catálogo de Sesiones</h2><button onclick="openSessionEditor()" class="bg-cnci-blue px-4 py-2 rounded-lg text-sm font-bold text-white hover:bg-blue-700 shadow-md flex items-center gap-2"><i class="fas fa-plus"></i> Nueva Sesión</button></div>
                    <div class="flex gap-4 mb-6 flex-wrap bg-white p-4 rounded-xl shadow-sm border border-gray-200"><input type="text" id="search-sessions" onkeyup="renderAdminSessions()" placeholder="Buscar..." class="bg-gray-50 border border-gray-300 text-gray-800 rounded-lg px-3 py-2 text-sm w-64 focus:border-cnci-blue outline-none"><select id="filter-session-cat" onchange="renderAdminSessions()" class="bg-gray-50 border border-gray-300 text-gray-800 rounded-lg px-3 py-2 text-sm outline-none"><option value="all">Todas Trayectorias</option></select><select id="filter-session-speaker" onchange="renderAdminSessions()" class="bg-gray-50 border border-gray-300 text-gray-800 rounded-lg px-3 py-2 text-sm outline-none"><option value="all">Todos Ponentes</option></select></div>
                    <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden"><table class="w-full text-left text-sm text-gray-600"><thead class="bg-gray-50 text-gray-400 uppercase font-bold text-xs border-b border-gray-200"><tr><th class="p-4">Título</th><th class="p-4">Trayectoria</th><th class="p-4">Ponente</th><th class="p-4 text-center">Duración</th><th class="p-4 text-center">Asist.</th><th class="p-4 text-center">Rating</th><th class="p-4 text-center">Acciones</th></tr></thead><tbody class="divide-y divide-gray-100" id="admin-sessions-table-body"></tbody></table><div class="p-4 bg-gray-50 flex justify-center border-t border-gray-200" id="pagination-sessions"></div></div>
                </div>

                <div id="admin-content-sections" class="hidden flex-1 p-8 overflow-y-auto bg-gray-50">
                    <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-gray-800 font-heading">Secciones del Home</h2><button onclick="openSectionEditor()" class="bg-cnci-blue px-4 py-2 rounded-lg text-sm font-bold text-white hover:bg-blue-700 shadow-md"><i class="fas fa-plus"></i> Nueva Sección</button></div>
                    <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden"><table class="w-full text-left text-sm text-gray-600"><thead class="bg-gray-50 text-gray-400 uppercase font-bold text-xs border-b border-gray-200"><tr><th class="p-4">Nombre de la Sección</th><th class="p-4 text-center">Estado</th><th class="p-4 text-center">Acciones</th></tr></thead><tbody class="divide-y divide-gray-100" id="admin-sections-table-body"></tbody></table></div>
                </div>
                
                <div id="admin-content-pathways" class="hidden flex-1 p-8 overflow-y-auto bg-gray-50">
                    <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-gray-800 font-heading">Trayectorias (Categorías)</h2><button onclick="openPathwayEditor()" class="bg-cnci-blue px-4 py-2 rounded-lg text-sm font-bold text-white hover:bg-blue-700 shadow-md"><i class="fas fa-plus"></i> Nueva Trayectoria</button></div>
                    <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden"><table class="w-full text-left text-sm text-gray-600"><thead class="bg-gray-50 text-gray-400 uppercase font-bold text-xs border-b border-gray-200"><tr><th class="p-4">Emoji</th><th class="p-4">Nombre</th><th class="p-4">Insignia</th><th class="p-4 text-center">Requisito</th><th class="p-4 text-center">Acciones</th></tr></thead><tbody class="divide-y divide-gray-100" id="admin-pathways-table-body"></tbody></table></div>
                </div>
                
                <div id="admin-content-users" class="hidden flex-1 p-8 overflow-y-auto bg-gray-50">
                    <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-gray-800 font-heading">Directorio de Alumnos</h2><div class="flex gap-3"><button onclick="downloadUsersCSV()" class="bg-green-600 px-4 py-2 rounded-lg text-sm font-bold text-white hover:bg-green-700 shadow-md">Exportar</button><button onclick="addUserManual()" class="bg-cnci-blue px-4 py-2 rounded-lg text-sm font-bold text-white hover:bg-blue-700 shadow-md">Añadir</button></div></div>
                    <div class="flex gap-4 mb-6"><input type="text" id="search-users" onkeyup="renderAdminUsers()" placeholder="Buscar matrícula..." class="bg-gray-50 border border-gray-300 text-gray-800 rounded-lg px-3 py-2 text-sm w-64 focus:border-cnci-blue outline-none"><select id="filter-users-status" onchange="renderAdminUsers()" class="bg-gray-50 border border-gray-300 text-gray-800 rounded-lg px-3 py-2 text-sm outline-none"><option value="all">Todos</option><option value="with_certs">Con Constancias</option></select></div>
                    <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden"><table class="w-full text-left text-sm text-gray-600"><thead class="bg-gray-50 text-gray-400 uppercase font-bold text-xs border-b border-gray-200"><tr><th class="p-4">Matrícula</th><th class="p-4 text-center">Asistencias</th><th class="p-4 text-center">Constancias</th><th class="p-4 text-center">Acciones</th></tr></thead><tbody class="divide-y divide-gray-100" id="admin-users-table-body"></tbody></table><div class="p-4 bg-gray-50 flex justify-center border-t border-gray-200" id="pagination-users"></div></div>
                </div>
                
                <div id="admin-content-attendance" class="hidden flex-1 p-8 overflow-y-auto bg-gray-50">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 font-heading">Gestión de Asistencias</h2>
                    <div class="grid md:grid-cols-3 gap-8">
                        <div class="md:col-span-1 space-y-6 bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                            <h3 class="font-bold text-gray-700 border-b border-gray-100 pb-2 mb-4">1. Cargar Datos</h3>
                            <div><label class="text-xs font-bold text-gray-500 uppercase block mb-1">Buscar Sesión</label><input type="text" id="import-session-search" onkeyup="filterImportSessions()" placeholder="Escribe título..." class="w-full bg-gray-50 border border-gray-300 text-gray-800 rounded-lg p-2.5 text-sm mb-2 focus:border-cnci-blue outline-none"><select id="import-session-select" onchange="renderSessionAttendanceTable()" class="w-full bg-gray-50 border border-gray-300 text-gray-800 rounded-lg p-2.5 text-sm mb-4" size="5"></select></div>
                            <div><label class="text-xs font-bold text-gray-500 uppercase block mb-1">Método de Carga</label><div class="mb-3"><input type="file" id="import-csv-file" accept=".csv,.txt" class="block w-full text-xs text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:bg-gray-100 file:text-cnci-blue hover:file:bg-gray-200"/></div><textarea id="import-text-area" rows="4" class="w-full bg-gray-50 border border-gray-300 text-gray-800 rounded-lg p-2.5 text-xs font-mono" placeholder="Pegar matrículas aquí..."></textarea></div>
                            <button onclick="processAttendanceImport()" class="w-full bg-green-600 text-white py-2.5 rounded-lg font-bold hover:bg-green-700 shadow-md transition text-sm">Validar Asistencias</button>
                        </div>
                        <div class="md:col-span-2">
                             <div class="flex justify-between items-center mb-4 bg-white p-4 rounded-xl border border-gray-200 shadow-sm"><div><h3 class="font-bold text-sm text-gray-800" id="attendance-session-title">Selecciona una sesión...</h3></div><button onclick="exportSessionAttendanceCSV()" class="text-gray-500 hover:text-cnci-blue"><i class="fas fa-file-csv text-xl"></i></button></div>
                            <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden"><table class="w-full text-left text-sm text-gray-600"><thead class="bg-gray-50 text-gray-400 uppercase font-bold text-xs border-b border-gray-200"><tr><th class="p-4">Alumno</th><th class="p-4 text-green-600 font-bold">Estado</th><th class="p-4 text-right">Acciones</th></tr></thead><tbody class="divide-y divide-gray-100" id="admin-attendance-table-body"></tbody></table><div class="p-4 bg-gray-50 flex justify-center border-t border-gray-200" id="pagination-attendance"></div></div>
                        </div>
                    </div>
                </div>

                <div id="admin-content-certificates" class="hidden flex-1 p-8 overflow-y-auto bg-gray-50">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 font-heading">Asignación de Constancias</h2>
                    <div class="grid md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm"><h3 class="text-sm font-bold text-cnci-orange mb-4 border-b border-gray-100 pb-2">Individual</h3><div class="space-y-3"><input type="text" id="cert-manual-id" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2.5 text-gray-800 text-sm uppercase outline-none focus:border-cnci-orange" placeholder="Matrícula"><select id="cert-manual-pathway" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2.5 text-gray-800 text-sm outline-none focus:border-cnci-orange"></select><input type="text" id="cert-manual-link" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2.5 text-gray-800 text-sm outline-none focus:border-cnci-orange" placeholder="Enlace (OneDrive)"><button onclick="assignCertificateManual()" class="w-full bg-cnci-blue py-2.5 rounded-lg font-bold text-white hover:bg-blue-700 shadow-md text-sm">Asignar</button></div></div>
                        <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm"><h3 class="text-sm font-bold text-green-600 mb-4 border-b border-gray-100 pb-2">Masivo (CSV)</h3><p class="text-[11px] text-gray-400 mb-3">Formato: <code>Matrícula,ID_Trayectoria,Link</code></p><input type="file" id="cert-csv-file" accept=".csv, .txt" class="block w-full text-xs text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded-full file:bg-gray-100 file:text-gray-700 mb-4"/><button onclick="processCertificateCSV()" class="w-full bg-green-600 py-2.5 rounded-lg font-bold text-white hover:bg-green-700 shadow-md text-sm">Procesar Archivo</button></div>
                        <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm flex flex-col justify-center items-center text-center"><div class="bg-blue-50 p-4 rounded-full mb-3"><i class="fas fa-file-export text-3xl text-cnci-blue"></i></div><h3 class="text-sm font-bold text-gray-700 mb-2">Reporte General</h3><button onclick="exportCertificatesCSV()" class="text-cnci-blue hover:underline text-sm font-medium">Descargar CSV de Entregas</button></div>
                    </div>
                    <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden"><table class="w-full text-left text-sm text-gray-600"><thead class="bg-gray-50 text-gray-400 uppercase font-bold text-xs border-b border-gray-200"><tr><th class="p-4">Alumno</th><th class="p-4">Trayectoria</th><th class="p-4">Link</th><th class="p-4 text-right">Acciones</th></tr></thead><tbody class="divide-y divide-gray-100" id="admin-certs-table-body"></tbody></table><div class="p-4 bg-gray-50 flex justify-center border-t border-gray-200" id="pagination-certs"></div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL EDITOR SESIONES -->
    <div id="session-editor-modal" class="fixed inset-0 z-[130] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white rounded-xl max-w-lg w-full p-8 border border-gray-200 shadow-2xl relative max-h-[90vh] overflow-y-auto">
            <button onclick="document.getElementById('session-editor-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 transition"><i class="fas fa-times text-xl"></i></button>
            <!-- ID AÑADIDO AQUÍ: editor-modal-title -->
            <h3 id="editor-modal-title" class="text-xl font-bold text-gray-800 mb-6 font-heading border-b border-gray-100 pb-2">Editar Sesión</h3>
            <input type="hidden" id="edit-id">
            <div class="space-y-4">
                <input type="text" id="edit-title" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-3 text-gray-800 text-sm focus:border-cnci-blue outline-none" placeholder="Título de la sesión">
                <textarea id="edit-desc" rows="3" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-3 text-gray-800 text-sm focus:border-cnci-blue outline-none" placeholder="Descripción breve"></textarea>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs font-bold text-gray-400 block mb-1">Trayectoria</label><select id="edit-category" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2.5 text-gray-800 text-sm outline-none"></select></div>
                    <div><label class="text-xs font-bold text-gray-400 block mb-1">Sección</label><select id="edit-type" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2.5 text-gray-800 text-sm outline-none"></select></div>
                </div>
                <div class="grid grid-cols-2 gap-4"><input type="text" id="edit-speaker" class="bg-gray-50 border border-gray-300 rounded-lg p-3 text-gray-800 text-sm outline-none" placeholder="Ponente"><input type="number" id="edit-duration" class="bg-gray-50 border border-gray-300 rounded-lg p-3 text-gray-800 text-sm outline-none" placeholder="Mins"></div>
                <div class="grid grid-cols-2 gap-4"><div><label class="text-xs font-bold text-gray-400 block mb-1">Fecha</label><input type="date" id="edit-date-day" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2.5 text-gray-800 text-sm outline-none"></div><div><label class="text-xs font-bold text-gray-400 block mb-1">Hora</label><input type="time" id="edit-date-time" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2.5 text-gray-800 text-sm outline-none"></div></div>
                <div class="border-t border-gray-100 pt-4 space-y-4">
                    <div><label class="text-xs font-bold text-gray-400 block mb-1">Enlace Acceso</label><input type="text" id="edit-link" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-3 text-gray-800 text-sm outline-none" placeholder="Teams/Zoom Link"></div>
                    <div><label class="text-xs font-bold text-cnci-blue block mb-1">Enlace Grabación</label><input type="text" id="edit-recording-link" class="w-full bg-blue-50 border border-blue-200 rounded-lg p-3 text-gray-800 text-sm outline-none" placeholder="Embed URL (OneDrive/YouTube)"></div>
                    <div><label class="text-xs font-bold text-gray-400 block mb-1">G-Calendar</label><input type="text" id="edit-gcal" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-3 text-gray-800 text-sm outline-none" placeholder="Link opcional"></div>
                </div>
                <input type="text" id="edit-image" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-3 text-gray-800 text-sm outline-none" placeholder="URL Imagen Miniatura">
                <div class="flex gap-3 justify-end pt-4 border-t border-gray-100"><button onclick="document.getElementById('session-editor-modal').classList.add('hidden')" class="px-5 py-2.5 text-gray-500 hover:text-gray-700 font-medium transition">Cancelar</button><button onclick="saveSessionForm()" class="px-6 py-2.5 bg-cnci-blue text-white rounded-lg font-bold hover:bg-blue-700 shadow-md transition">Guardar Sesión</button></div>
            </div>
        </div>
    </div>

    <!-- MODAL EDITOR TRAYECTORIAS -->
    <div id="pathway-editor-modal" class="fixed inset-0 z-[135] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white rounded-xl max-w-sm w-full p-8 border border-gray-200 shadow-2xl relative">
            <button onclick="document.getElementById('pathway-editor-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 transition"><i class="fas fa-times text-xl"></i></button>
            <h3 class="text-xl font-bold text-gray-800 mb-6 border-b border-gray-100 pb-2">Editar Trayectoria</h3>
            <input type="hidden" id="path-edit-id">
            <div class="space-y-4">
                <input type="text" id="path-edit-key" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-3 text-gray-800 text-sm uppercase outline-none" placeholder="ID Único">
                <input type="text" id="path-edit-name" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-3 text-gray-800 text-sm outline-none" placeholder="Nombre Visible">
                <input type="text" id="path-edit-badge" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-3 text-gray-800 text-sm outline-none" placeholder="Nombre Insignia">
                <div class="grid grid-cols-2 gap-4"><input type="text" id="path-edit-emoji" class="bg-gray-50 border border-gray-300 rounded-lg p-3 text-gray-800 text-center text-xl outline-none" placeholder="Emoji"><input type="number" id="path-edit-req" class="bg-gray-50 border border-gray-300 rounded-lg p-3 text-gray-800 text-sm outline-none" placeholder="Req #"></div>
                <div class="flex gap-3 justify-end pt-4"><button onclick="document.getElementById('pathway-editor-modal').classList.add('hidden')" class="px-4 py-2 text-gray-500 hover:text-gray-700 font-medium">Cancelar</button><button onclick="savePathwayForm()" class="px-6 py-2 bg-cnci-blue text-white rounded-lg font-bold hover:bg-blue-700 shadow-md">Guardar</button></div>
            </div>
        </div>
    </div>

    <!-- MODAL EDITOR SECCIONES -->
    <div id="section-editor-modal" class="fixed inset-0 z-[140] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white rounded-xl max-w-sm w-full p-8 border border-gray-200 shadow-2xl relative">
            <button onclick="document.getElementById('section-editor-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 transition"><i class="fas fa-times text-xl"></i></button>
            <h3 class="text-xl font-bold text-gray-800 mb-6 border-b border-gray-100 pb-2">Editar Sección</h3>
            <input type="hidden" id="sect-edit-id">
            <div class="space-y-4">
                <input type="text" id="sect-edit-key" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-3 text-gray-800 text-sm uppercase outline-none" placeholder="ID (ej. webinars)">
                <input type="text" id="sect-edit-name" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-3 text-gray-800 text-sm outline-none" placeholder="Nombre Visible">
                <div class="flex gap-3 justify-end pt-4"><button onclick="document.getElementById('section-editor-modal').classList.add('hidden')" class="px-4 py-2 text-gray-500 hover:text-gray-700 font-medium">Cancelar</button><button onclick="saveSectionForm()" class="px-6 py-2 bg-cnci-blue text-white rounded-lg font-bold hover:bg-blue-700 shadow-md">Guardar</button></div>
            </div>
        </div>
    </div>

    <!-- MODAL EDITOR ALUMNO -->
    <div id="student-editor-modal" class="fixed inset-0 z-[145] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white rounded-xl max-w-sm w-full p-8 border border-gray-200 shadow-2xl relative">
            <button onclick="document.getElementById('student-editor-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 transition"><i class="fas fa-times text-xl"></i></button>
            <h3 class="text-xl font-bold text-gray-800 mb-6">Editar Alumno</h3>
            <input type="hidden" id="student-edit-id">
            <div class="space-y-4">
                <div class="bg-blue-50 p-3 rounded-lg text-center text-cnci-blue font-bold font-mono" id="student-edit-display-id"></div>
                <div><label class="text-xs font-bold text-gray-400 block mb-1">Nueva Contraseña</label><input type="text" id="student-edit-pass" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-3 text-gray-800 text-sm outline-none" placeholder="Dejar vacío para mantener"></div>
                <div class="flex gap-3 justify-end pt-4"><button onclick="document.getElementById('student-editor-modal').classList.add('hidden')" class="px-4 py-2 text-gray-500 hover:text-gray-700 font-medium">Cancelar</button><button onclick="saveUserForm()" class="px-6 py-2 bg-cnci-blue text-white rounded-lg font-bold hover:bg-blue-700 shadow-md">Guardar</button></div>
            </div>
        </div>
    </div>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, deleteDoc, onSnapshot, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyB4q7TQoyTKY-bBHzvhr2hf3je15MJO760", authDomain: "hubbienestarydesarrollocnci.firebaseapp.com", projectId: "hubbienestarydesarrollocnci", storageBucket: "hubbienestarydesarrollocnci.firebasestorage.app", messagingSenderId: "752549669907", appId: "1:752549669907:web:efd2936f3aad533b05e3e6", measurementId: "G-WX4PH3XFJQ" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        window.db = db;
        window.fb = { collection, doc, setDoc, getDoc, updateDoc, deleteDoc, onSnapshot, query, where, getDocs };
        signInAnonymously(auth).then(() => {
            console.log("Firebase Ready");
            document.getElementById('loading-overlay').classList.add('opacity-0');
            setTimeout(() => document.getElementById('loading-overlay').remove(), 500);
            window.dispatchEvent(new CustomEvent('firebase-ready'));
        });
    </script>

    <script>
        const ITEMS_PER_PAGE = 15;
        let categoriesDB = {};
        let sessionTypesDB = {};
        let sessions = [];
        let usersDB = {};
        let currentUser = null;
        let currentUserData = null;
        let currentModalSession = null;
        let currentPage = { sessions: 1, users: 1, attendance: 1, certs: 1 };
        let currentAttendanceSessionId = null;
        let currentFilterPathway = 'all';
        let currentSearchQuery = "";
        window.charts = {};
        let siteConfig = { aboutVideo: "", aboutText: "Información pendiente...", logoUrl: "https://i.ibb.co/m5QcyKWg/Logo-CNCI.png" };

        window.handleProfileClick = function() { if(currentUser) { const dd = document.getElementById('profile-dropdown'); dd.classList.toggle('hidden'); dd.classList.toggle('flex'); } else document.getElementById('login-modal').classList.remove('hidden'); };
        window.addEventListener('firebase-ready', init);

        function init() { setupRealtimeListeners(); checkSession(); setupNavbarScroll(); }

        function setupRealtimeListeners() {
            window.fb.onSnapshot(window.fb.collection(window.db, "sessions"), (snapshot) => {
                sessions = [];
                snapshot.forEach((doc) => sessions.push({ id: parseInt(doc.id), ...doc.data() }));
                sessions.sort((a,b) => new Date(a.startTime) - new Date(b.startTime));
                renderHero(); renderRows(); renderRecordingsGrid(); renderCalendar(); renderNotifications();
                if(window.isAdminMode) { renderAdminSessions(); renderAdminStats(); populateFilters(); }
            });
            window.fb.onSnapshot(window.fb.collection(window.db, "categories"), (snapshot) => {
                categoriesDB = {};
                snapshot.forEach((doc) => categoriesDB[doc.id] = doc.data());
                renderFilters(); renderRows(); renderCalendar(); renderNotifications();
                if(window.isAdminMode) { renderAdminPathways(); populateFilters(); }
            });
            window.fb.onSnapshot(window.fb.collection(window.db, "session_types"), (snapshot) => {
                sessionTypesDB = {};
                snapshot.forEach((doc) => sessionTypesDB[doc.id] = doc.data());
                renderRows(); renderCalendar();
                if(window.isAdminMode) renderAdminSections();
            });
            window.fb.onSnapshot(window.fb.doc(window.db, "site_config", "general"), (doc) => {
                if(doc.exists()) { siteConfig = doc.data(); }
                applySiteConfig();
            });
        }
        
        function applySiteConfig() {
            const logo = document.getElementById('nav-logo');
            if(siteConfig.logoUrl) logo.src = siteConfig.logoUrl;
            document.getElementById('about-text-content').innerText = siteConfig.aboutText || "Información pendiente...";
            document.getElementById('about-video-frame').src = siteConfig.aboutVideo || "";
            if(window.isAdminMode) {
                 document.getElementById('conf-logo-url').value = siteConfig.logoUrl || "";
                 document.getElementById('conf-about-video').value = siteConfig.aboutVideo || "";
                 document.getElementById('conf-about-text').value = siteConfig.aboutText || "";
            }
        }

        // --- AUTH ---
        window.attemptLogin = async function() {
            const id = document.getElementById('student-id').value.trim().toUpperCase();
            const pass = document.getElementById('student-pass').value.trim();
            if(!id.startsWith('AL') || id.length < 6) return Swal.fire('Error', 'Matrícula inválida', 'error');
            if(!pass) return Swal.fire('Error', 'Ingrese contraseña', 'error');
            const docRef = window.fb.doc(window.db, "students", id);
            const docSnap = await window.fb.getDoc(docRef);
            if (!docSnap.exists()) {
                await window.fb.setDoc(docRef, { id: id, password: pass, verifiedSessions: [], certificates: [], favorites: [], ratings: {}, lastAccess: new Date().toISOString() });
                loginSuccess(id);
            } else {
                const data = docSnap.data();
                if(data.password === pass) { await window.fb.updateDoc(docRef, { lastAccess: new Date().toISOString() }); loginSuccess(id); }
                else { Swal.fire('Error', 'Contraseña incorrecta', 'error'); }
            }
        };

        function loginSuccess(id) {
            localStorage.setItem('cnci_currentUser', id);
            currentUser = id;
            document.getElementById('login-modal').classList.add('hidden');
            subscribeToUser(id);
            Swal.fire({ icon: 'success', title: 'Bienvenido', timer: 1500, showConfirmButton: false });
        }
        function subscribeToUser(id) {
            window.fb.onSnapshot(window.fb.doc(window.db, "students", id), (doc) => {
                currentUserData = doc.data();
                document.getElementById('user-avatar').src = `https://ui-avatars.com/api/?name=${id}&background=2a6aff&color=fff`;
                document.getElementById('user-greeting').innerText = `Hola, ${id}`;
                renderNotifications();
                if(!document.getElementById('pathways-modal').classList.contains('hidden')) window.openPathwaysModal();
            });
        }
        window.logout = function() { localStorage.removeItem('cnci_currentUser'); location.reload(); };
        function checkSession() { const u = localStorage.getItem('cnci_currentUser'); if(u) { currentUser = u; subscribeToUser(u); } }

        // --- CALENDAR LOGIC ---
        let calCurrentDate = new Date();
        window.changeMonth = function(offset) { calCurrentDate.setMonth(calCurrentDate.getMonth() + offset); renderCalendar(); };
        
        window.renderCalendar = function() {
            const container = document.getElementById('calendar-days');
            const monthTitle = document.getElementById('cal-month-year');
            const filterCat = document.getElementById('cal-filter-cat');
            const filterSec = document.getElementById('cal-filter-sec');
            
            if(filterCat.options.length <= 1) { Object.values(categoriesDB).forEach(c => filterCat.innerHTML += `<option value="${c.id}">${c.name}</option>`); }
            if(filterSec.options.length <= 1) { Object.values(sessionTypesDB).forEach(t => filterSec.innerHTML += `<option value="${t.id}">${t.name}</option>`); }
            
            const month = calCurrentDate.getMonth();
            const year = calCurrentDate.getFullYear();
            monthTitle.innerText = calCurrentDate.toLocaleString('es-MX', { month: 'long', year: 'numeric' });
            
            container.innerHTML = "";
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            for(let i=0; i<firstDay; i++) { container.innerHTML += `<div class="calendar-day empty"></div>`; }
            
            for(let d=1; d<=daysInMonth; d++) {
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const daySessions = sessions.filter(s => {
                    const sDate = s.startTime.substring(0, 10);
                    const matchDate = sDate === dateStr;
                    const matchCat = filterCat.value === 'all' || s.category === filterCat.value;
                    const matchSec = filterSec.value === 'all' || s.typeId === filterSec.value;
                    return matchDate && matchCat && matchSec;
                });
                
                let eventsHTML = daySessions.map(s => {
                    const cat = categoriesDB[s.category] || {emoji:''};
                    const json = JSON.stringify(s).replace(/"/g, '&quot;');
                    return `<div class="calendar-event bg-cnci-blue text-white" onclick='openModal(${json}); event.stopPropagation();'>${cat.emoji} ${s.title.substring(0,20)}..</div>`;
                }).join('');
                
                container.innerHTML += `<div class="calendar-day"><span class="day-number text-gray-500">${d}</span>${eventsHTML}</div>`;
            }
        };

        // --- FRONTEND ---
        function renderNotifications() { /* ... */ const badge = document.getElementById('notif-badge'); const list = document.getElementById('notif-list'); list.innerHTML = ""; let count = 0; if (currentUserData) { if(currentUserData.certificates) { currentUserData.certificates.forEach(c => { if(!c.accessed) { count++; const cat = categoriesDB[c.pathway] || {}; list.innerHTML += `<div class="p-3 border-b border-gray-100 hover:bg-gray-50 cursor-pointer" onclick="openPathwaysModal()"><div class="flex items-center gap-2"><i class="fas fa-award text-yellow-500"></i><div class="text-xs text-gray-800">Constancia disponible: <span class="font-bold">${cat.name}</span></div></div></div>`; } }); } } const today = new Date(); const limit = new Date(today); limit.setDate(today.getDate() + 3); sessions.forEach(s => { const sDate = new Date(s.startTime); if(sDate > today && sDate < limit) { count++; list.innerHTML += `<div class="p-3 border-b border-gray-100 hover:bg-gray-50 cursor-pointer" onclick="openModal(${JSON.stringify(s).replace(/"/g, '&quot;')})"><div class="flex items-center gap-2"><i class="fas fa-video text-cnci-blue"></i><div class="text-xs text-gray-800">Próxima Sesión: <span class="font-bold">${s.title}</span><div class="text-[10px] text-gray-400">${formatMXDate(s.startTime)}</div></div></div></div>`; } }); if(count > 0 && document.getElementById('notification-dropdown').classList.contains('hidden')) { badge.innerText = count; badge.classList.remove('hidden'); } else { badge.classList.add('hidden'); } if(count===0) list.innerHTML = `<div class="p-4 text-center text-gray-400 text-xs">No tienes notificaciones nuevas.</div>`; }
        window.handleGlobalSearch = function(val) { currentSearchQuery = val.toLowerCase(); renderRows(); };
        window.setPathwayFilter = function(id) { currentFilterPathway = id; renderFilters(); renderRows(); renderRecordingsGrid(); };
        function formatMXDate(iso) { if(!iso) return "-"; return new Date(iso).toLocaleString('es-MX', { timeZone: 'America/Mexico_City', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: true }) + " (CDMX)"; }
        function getSessionStatus(s) { const n = new Date(); const start = new Date(s.startTime); const end = new Date(start.getTime() + s.durationMinutes * 60000); if(n >= start && n <= end) return 'LIVE'; else if(n < start) return 'UPCOMING'; return 'RECORDED'; }
        function getMatchPercentage(session, user) { if (!user || user.verifiedSessions.length === 0) return 98; const catCounts = {}; user.verifiedSessions.forEach(sid => { const s = sessions.find(x => x.id === sid); if(s) catCounts[s.category] = (catCounts[s.category] || 0) + 1; }); const sortedCats = Object.keys(catCounts).sort((a,b) => catCounts[b] - catCounts[a]); if (session.category === sortedCats[0]) return 98; return 85; }

        function renderHero() {
            if(sessions.length===0) { document.getElementById('hero-section').innerHTML = '<div class="flex items-center justify-center h-full text-gray-400">Sin sesiones activas</div>'; return; }
            let hero = sessions.find(s => getSessionStatus(s)==='LIVE') || sessions.find(s => s.featured && getSessionStatus(s)==='UPCOMING') || sessions[sessions.length-1];
            if(!hero) return;
            const status = getSessionStatus(hero); const cat = categoriesDB[hero.category] || {name: hero.category, emoji: ''}; let badgeHTML = status==='LIVE' ? '<span class="bg-cnci-orange text-white font-bold text-xs px-2 py-1 rounded shadow-lg animate-pulse">EN VIVO</span>' : `<span class="bg-white/20 backdrop-blur-md text-white font-bold text-xs px-2 py-1 rounded flex items-center gap-2"><i class="far fa-calendar-alt"></i> ${formatMXDate(hero.startTime).split(' ')[0]}</span>`;
            const json = JSON.stringify(hero).replace(/"/g, '&quot;');
            document.getElementById('hero-section').innerHTML = `<div class="absolute inset-0"><img src="${hero.image}" class="w-full h-full object-cover" onerror="handleImageError(this)"><div class="absolute inset-0 hero-overlay"></div><div class="absolute inset-0 hero-gradient"></div></div><div class="absolute top-[30%] left-4 md:left-12 max-w-2xl space-y-5 animate-fade-in"><div class="flex items-center gap-3">${badgeHTML} <span class="text-white/80 font-bold tracking-widest text-sm uppercase">Destacado</span></div><h1 class="text-4xl md:text-6xl font-bold text-white drop-shadow-lg leading-tight font-heading">${hero.title}</h1><div class="flex items-center gap-4 text-sm font-semibold"><span class="text-green-400 bg-white/10 px-2 py-1 rounded backdrop-blur-sm">98% Match</span><span class="text-gray-300">${hero.durationMinutes} min</span><span class="text-blue-300 flex items-center gap-1">${cat.emoji} ${cat.name}</span></div><p class="text-gray-200 text-lg drop-shadow-md line-clamp-3 max-w-xl">${hero.desc}</p><div class="flex gap-4 pt-4"><button onclick="openModal(${json})" class="bg-cnci-blue text-white px-8 py-3 rounded-lg hover:bg-blue-700 font-bold transition shadow-lg shadow-blue-500/30">Ver Detalles</button></div></div>`;
        }

        // RENDER ROWS (Filter by Enabled Sections)
        function renderRows() {
            const container = document.getElementById('content-rows');
            container.innerHTML = "";
            Object.values(sessionTypesDB).forEach(type => {
                if (type.enabled === false) return;
                const filtered = sessions.filter(s => { const st = getSessionStatus(s); const matchTime = st === 'LIVE' || st === 'UPCOMING'; const matchType = s.typeId === type.id; const matchPathway = currentFilterPathway === 'all' || s.category === currentFilterPathway; const matchSearch = currentSearchQuery === "" || s.title.toLowerCase().includes(currentSearchQuery); return matchTime && matchType && matchPathway && matchSearch; });
                if(filtered.length === 0) return;
                container.innerHTML += `<div class="mb-8 group/row animate-fade-in"><h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2 pl-2 border-l-4 border-cnci-blue font-heading">${type.name}</h2><div class="relative group/slider"><div class="flex overflow-x-auto gap-4 hide-scroll-bar py-4 px-1 scroll-smooth">${filtered.map(s => { const cat = categoriesDB[s.category] || {emoji:''}; return createCardHTML(s, cat, 'w-[280px]', 'h-[158px]'); }).join('')}</div></div></div>`;
            });
        }

        function renderRecordingsGrid() {
            const container = document.getElementById('recordings-grid');
            const select = document.getElementById('recordings-filter');
            container.innerHTML = "";
            if(select.options.length <= 1) { select.innerHTML = '<option value="all">Todas las Trayectorias</option>'; Object.values(categoriesDB).forEach(cat => { const opt = document.createElement('option'); opt.value = cat.id; opt.innerText = `${cat.emoji} ${cat.name}`; select.appendChild(opt); }); }
            const filterVal = select.value;
            let recs = sessions.filter(s => getSessionStatus(s) === 'RECORDED');
            if(currentFilterPathway !== 'all') recs = recs.filter(s => s.category === currentFilterPathway); else if(filterVal !== 'all') recs = recs.filter(s => s.category === filterVal);
            if(recs.length === 0) { container.innerHTML = `<div class="col-span-full text-center text-gray-400 py-10">No hay sesiones disponibles.</div>`; return; }
            recs.forEach(s => { const cat = categoriesDB[s.category] || {emoji: ''}; container.innerHTML += createCardHTML(s, cat); });
        }

        function createCardHTML(s, cat, widthClass = 'w-full', heightClass = 'h-[140px]') { const json = JSON.stringify(s).replace(/"/g, '&quot;'); return `<div class="movie-card relative flex-none ${widthClass} ${heightClass} rounded-lg overflow-hidden bg-white" onclick="openModal(${json})"><img src="${s.image}" class="w-full h-full object-cover opacity-90 hover:opacity-100 transition" onerror="handleImageError(this)"><div class="absolute bottom-0 left-0 right-0 p-3 bg-gradient-to-t from-black/90 to-transparent"><p class="text-white text-xs font-bold truncate">${cat.emoji} ${s.title}</p></div></div>`; }
        function renderFilters() { const c = document.getElementById('pathway-filters'); c.innerHTML = `<button onclick="setPathwayFilter('all')" class="px-4 py-1.5 rounded-full text-xs font-bold border border-gray-200 shadow-sm hover:bg-cnci-blue hover:text-white transition ${currentFilterPathway==='all'?'bg-cnci-blue text-white':'text-gray-500 bg-white'}">Todas</button>`; Object.values(categoriesDB).forEach(cat => { c.innerHTML += `<button onclick="setPathwayFilter('${cat.id}')" class="px-4 py-1.5 rounded-full text-xs font-bold border border-gray-200 shadow-sm hover:bg-cnci-blue hover:text-white transition ${currentFilterPathway===cat.id?'bg-cnci-blue text-white':'text-gray-500 bg-white'}">${cat.emoji} ${cat.name}</button>`; }); }

        // --- MODALS ---
        window.openModal = function(data) {
            currentModalSession = data;
            const modal = document.getElementById('modal');
            const cat = categoriesDB[data.category] || {};
            const status = getSessionStatus(data);
            const isEmbed = status === 'RECORDED' && (data.recordingLink || (data.link && data.link.includes('embed')));
            const finalLink = status === 'RECORDED' && data.recordingLink ? data.recordingLink : data.link;

            document.getElementById('modal-title').innerText = `${cat.emoji || ''} ${data.title}`;
            document.getElementById('modal-title-alt').innerText = data.title;
            document.getElementById('modal-desc').innerText = data.desc;
            document.getElementById('modal-speaker').innerText = data.speaker;
            document.getElementById('modal-category').innerText = cat.name || data.category;
            document.getElementById('modal-duration').innerText = formatMXDate(data.startTime);
            document.getElementById('modal-pathway-name').innerText = cat.badge || 'Certificado';
            
            const embedContainer = document.getElementById('modal-embed-container');
            const heroContainer = document.getElementById('modal-hero-container');
            const linkBtn = document.getElementById('modal-link-btn');
            const ratingContainer = document.getElementById('modal-rating-container');

            if(isEmbed) { embedContainer.classList.remove('hidden'); heroContainer.classList.add('hidden'); document.getElementById('modal-title-alt').classList.remove('hidden'); document.getElementById('modal-iframe').src = finalLink; linkBtn.classList.add('hidden'); } 
            else { embedContainer.classList.add('hidden'); heroContainer.classList.remove('hidden'); document.getElementById('modal-title-alt').classList.add('hidden'); document.getElementById('modal-img').src = data.image; document.getElementById('modal-iframe').src = ""; linkBtn.classList.remove('hidden'); linkBtn.href = finalLink; 
                if(status === 'RECORDED') { linkBtn.innerHTML = '<i class="fas fa-play mr-2"></i> Ver Grabación'; if(!finalLink) { linkBtn.href = "javascript:void(0)"; linkBtn.classList.add("opacity-50", "cursor-not-allowed"); } } 
                else { linkBtn.innerHTML = '<i class="fas fa-external-link-alt mr-2"></i> Ingresar'; linkBtn.classList.remove("opacity-50", "cursor-not-allowed"); }
            }

            if (status === 'RECORDED') { ratingContainer.classList.remove('hidden'); if (currentUserData && currentUserData.ratings && currentUserData.ratings[data.id]) { document.getElementById(`star${currentUserData.ratings[data.id]}`).checked = true; } else { document.querySelectorAll('.star-rating input').forEach(i => i.checked = false); } const avg = data.ratingAvg ? data.ratingAvg.toFixed(1) : '-'; document.getElementById('modal-avg-rating').innerHTML = `<i class="fas fa-star"></i> ${avg}`; } else { ratingContainer.classList.add('hidden'); document.getElementById('modal-avg-rating').innerHTML = ''; }
            document.getElementById('modal-gcal-btn').href = data.gcal || "#";
            document.getElementById('modal-time-status').innerText = status === 'LIVE' ? "En Vivo" : (status === 'UPCOMING' ? "Próximamente" : "Grabación");
            const btn = document.getElementById('btn-favorite');
            const isFav = currentUserData && currentUserData.favorites && currentUserData.favorites.includes(data.id);
            if(isFav) { btn.innerHTML = '<i class="fas fa-heart"></i>'; btn.className = "bg-pink-600 border border-pink-600 text-white px-4 py-2 rounded-lg transition hover:bg-pink-700"; } else { btn.innerHTML = '<i class="far fa-heart"></i>'; btn.className = "bg-white/20 backdrop-blur-md text-white border border-white/30 px-4 py-2.5 rounded-lg hover:bg-white hover:text-pink-600 transition"; }
            modal.classList.remove('hidden'); setTimeout(() => { modal.classList.remove('opacity-0'); document.getElementById('modal-content').classList.remove('scale-95'); document.getElementById('modal-content').classList.add('scale-100'); }, 10);
        };

        window.openAboutModal = function() { document.getElementById('about-modal').classList.remove('hidden'); };
        window.rateSession = async function(score) { if(!currentUser) { document.getElementById('login-modal').classList.remove('hidden'); return; } const sid = currentModalSession.id; if(!currentUserData.ratings) currentUserData.ratings = {}; currentUserData.ratings[sid] = score; await window.fb.updateDoc(window.fb.doc(window.db, "students", currentUser), { ratings: currentUserData.ratings }); let currentAvg = currentModalSession.ratingAvg || 0; let currentCount = currentModalSession.ratingCount || 0; const newCount = currentCount + 1; const newAvg = ((currentAvg * currentCount) + score) / newCount; await window.fb.updateDoc(window.fb.doc(window.db, "sessions", sid.toString()), { ratingAvg: newAvg, ratingCount: newCount }); Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: '¡Calificación enviada!', showConfirmButton: false, timer: 1500 }); };
        window.closeModal = function() { const m=document.getElementById('modal'); const c=document.getElementById('modal-content'); m.classList.add('opacity-0'); c.classList.remove('scale-100'); c.classList.add('scale-95'); document.getElementById('modal-iframe').src = ""; setTimeout(() => m.classList.add('hidden'), 300); };
        window.toggleFavorite = async function() { if(!currentUser) { document.getElementById('login-modal').classList.remove('hidden'); return; } const sid = currentModalSession.id; let favs = currentUserData.favorites || []; if(favs.includes(sid)) favs = favs.filter(id => id !== sid); else favs.push(sid); await window.fb.updateDoc(window.fb.doc(window.db, "students", currentUser), { favorites: favs }); window.openModal(currentModalSession); };
        window.openPathwaysModal = function() {
            if(!currentUser) { document.getElementById('login-modal').classList.remove('hidden'); return; }
            const modal = document.getElementById('pathways-modal');
            const user = currentUserData;
            document.getElementById('profile-modal-avatar').src = `https://ui-avatars.com/api/?name=${currentUser}&background=2a6aff&color=fff&size=128`;
            document.getElementById('profile-modal-id').innerText = currentUser;
            const favContainer = document.getElementById('favorites-container');
            favContainer.innerHTML = "";
            if(user.favorites && user.favorites.length > 0) {
                user.favorites.forEach(fid => {
                    const s = sessions.find(x => x.id === fid);
                    if(s) {
                        const cat = categoriesDB[s.category] || {};
                        const st = getSessionStatus(s);
                        let stBadge = st === 'LIVE' ? '<span class="text-red-500 text-[10px] font-bold">● EN VIVO</span>' : (st === 'UPCOMING' ? '<span class="text-blue-400 text-[10px]">● PRÓXIMA</span>' : '<span class="text-gray-400 text-[10px]">● GRABACIÓN</span>');
                        const json = JSON.stringify(s).replace(/"/g, '&quot;');
                        favContainer.innerHTML += `<div class="bg-gray-50 rounded-lg p-3 flex gap-3 cursor-pointer hover:bg-gray-100 items-center border border-gray-100 shadow-sm" onclick="closeModal(); setTimeout(()=>openModal(${json}), 300)"><img src="${s.image}" class="w-16 h-12 object-cover rounded" onerror="handleImageError(this)"><div class="overflow-hidden w-full"><div class="flex justify-between items-center">${stBadge}</div><p class="text-gray-800 text-xs font-bold truncate mt-1">${s.title}</p><p class="text-gray-500 text-[10px]">${cat.name}</p></div></div>`;
                    }
                });
            } else favContainer.innerHTML = `<p class="text-gray-400 text-sm col-span-full italic">No tienes sesiones guardadas aún.</p>`;
            const pathContainer = document.getElementById('pathways-container');
            pathContainer.innerHTML = '';
            Object.values(categoriesDB).forEach(path => {
                const verifiedCount = user.verifiedSessions.filter(sid => { const s = sessions.find(sx => sx.id == sid); return s && s.category === path.id; }).length;
                const progress = Math.min((verifiedCount / path.req) * 100, 100);
                const isCompleted = verifiedCount >= path.req;
                const cert = user.certificates ? user.certificates.find(c => c.pathway === path.id) : null;
                let btn = cert ? `<a href="${cert.link}" target="_blank" onclick="trackCertClick('${currentUser}', '${path.id}')" class="bg-green-600 text-white text-xs py-1.5 px-3 rounded-lg shadow-sm hover:bg-green-700">Descargar</a>` : (isCompleted ? `<span class="text-yellow-600 text-xs font-bold bg-yellow-50 px-2 py-1 rounded">En Proceso</span>` : `<span class="text-gray-400 text-xs"><i class="fas fa-lock"></i></span>`);
                pathContainer.innerHTML += `<div class="bg-gray-50 rounded-lg p-4 border border-gray-100 flex gap-4 items-center shadow-sm"><div class="text-2xl">${path.emoji}</div><div class="flex-1"><h4 class="text-gray-800 text-sm font-bold">${path.name}</h4><div class="w-full bg-gray-200 h-2 mt-2 rounded-full"><div class="bg-cnci-blue h-2 rounded-full transition-all duration-500" style="width:${progress}%"></div></div><p class="text-[10px] text-gray-500 mt-1">${verifiedCount}/${path.req} sesiones</p></div><div>${btn}</div></div>`;
            });
            modal.classList.remove('hidden');
        };
        window.trackCertClick = async function(uid, pid) { const u = usersDB[uid]; if(u && u.certificates) { const c = u.certificates.find(x => x.pathway === pid); if(c && !c.accessed) { c.accessed = true; await window.fb.updateDoc(window.fb.doc(window.db, "students", uid), { certificates: u.certificates }); } } };

        // --- ADMIN ---
        window.openAdminModal = function() { document.getElementById('admin-modal').classList.remove('hidden'); document.getElementById('admin-login-view').classList.remove('hidden'); document.getElementById('admin-dashboard-view').classList.add('hidden'); document.getElementById('admin-pass').value = ''; };
        window.closeAdminModal = function() { document.getElementById('admin-modal').classList.add('hidden'); window.isAdminMode = false; };
        window.verifyAdmin = async function() { if(document.getElementById('admin-pass').value === 'cnci2026') { window.isAdminMode = true; const q = window.fb.query(window.fb.collection(window.db, "students")); const querySnapshot = await window.fb.getDocs(q); usersDB = {}; querySnapshot.forEach((doc) => usersDB[doc.id] = doc.data()); document.getElementById('admin-login-view').classList.add('hidden'); document.getElementById('admin-dashboard-view').classList.remove('hidden'); document.getElementById('admin-dashboard-view').classList.add('flex'); showAdminTab('stats'); } else Swal.fire('Error', 'Incorrecto', 'error'); };
        window.showAdminTab = function(tab) { document.querySelectorAll('.admin-tab-btn').forEach(b => { b.classList.remove('bg-cnci-blue', 'text-white', 'shadow-md'); b.classList.add('text-gray-600', 'hover:bg-gray-50'); }); document.getElementById(`tab-btn-${tab}`).classList.add('bg-cnci-blue', 'text-white', 'shadow-md'); document.getElementById(`tab-btn-${tab}`).classList.remove('text-gray-600', 'hover:bg-gray-50'); ['stats','sessions','sections','pathways','config','users','attendance','certificates'].forEach(t => document.getElementById(`admin-content-${t}`).classList.add('hidden')); document.getElementById(`admin-content-${tab}`).classList.remove('hidden'); if(tab==='stats') renderAdminStats(); else if(tab==='sessions') { populateFilters(); renderAdminSessions(); } else if(tab==='sections') renderAdminSections(); else if(tab==='pathways') renderAdminPathways(); else if(tab==='attendance') { filterImportSessions(); renderSessionAttendanceTable(); } else if(tab==='certificates') { populateCertPathways(); renderAdminCertificates(); } else if(tab==='users') renderAdminUsers(); };

        // Admin Config Save
        window.saveSiteConfig = async function() {
            const videoUrl = window.getEmbedUrl(document.getElementById('conf-about-video').value);
            // Default logo if empty
            const logoUrl = document.getElementById('conf-logo-url').value || "https://i.ibb.co/m5QcyKWg/Logo-CNCI.png";
            
            await window.fb.setDoc(window.fb.doc(window.db, "site_config", "general"), {
                aboutVideo: videoUrl,
                aboutText: document.getElementById('conf-about-text').value,
                logoUrl: logoUrl
            });
            Swal.fire("Guardado", "Configuración actualizada", "success");
        };

        // Render Functions
        function renderAdminStats() { /* same */ const mode = document.getElementById('stats-chart-type').value; let topSessions = []; if (mode === 'attendance') { const sessionAttendance = {}; Object.values(usersDB).forEach(u => u.verifiedSessions.forEach(sid => sessionAttendance[sid] = (sessionAttendance[sid]||0)+1)); topSessions = Object.entries(sessionAttendance).sort((a,b) => b[1] - a[1]).slice(0, 5); } else { topSessions = sessions.filter(s => s.ratingAvg).sort((a,b) => b.ratingAvg - a.ratingAvg).slice(0, 5).map(s => [s.id, s.ratingAvg]); } renderChart('chart-top-sessions', 'bar', topSessions.map(x => { const s = sessions.find(s=>s.id == x[0]); return s ? s.title.substring(0, 15)+'...' : 'ID:'+x[0]; }), topSessions.map(x => x[1]), mode === 'attendance' ? 'Asistencias' : 'Calificación', '#2a6aff'); const catPopularity = {}; const monthlyAttendance = {}; Object.values(usersDB).forEach(u => u.verifiedSessions.forEach(sid => { const s = sessions.find(x => x.id === sid); if(s) { catPopularity[s.category] = (catPopularity[s.category] || 0) + 1; const monthKey = new Date(s.startTime).toLocaleString('es-MX', { month: 'short', year: '2-digit' }); monthlyAttendance[monthKey] = (monthlyAttendance[monthKey] || 0) + 1; } })); renderChart('chart-pathways', 'doughnut', Object.keys(catPopularity).map(k => categoriesDB[k]?.name || k), Object.values(catPopularity), 'Popularidad', ['#2a6aff', '#ff8500', '#10B981', '#F59E0B']); renderChart('chart-attendance-month', 'line', Object.keys(monthlyAttendance), Object.values(monthlyAttendance), 'Asistencias', '#ff8500'); }
        function renderChart(id, type, labels, data, label, color) { const ctx = document.getElementById(id).getContext('2d'); if(window.charts[id]) window.charts[id].destroy(); window.charts[id] = new Chart(ctx, { type: type, data: { labels: labels, datasets: [{ label: label, data: data, backgroundColor: color, borderColor: Array.isArray(color) ? null : color, borderWidth: 1 }] }, options: { responsive: true, plugins: { legend: { display: type === 'doughnut', position: 'bottom', labels: { color: 'black' } } }, scales: type !== 'doughnut' ? { y: { ticks: { color: 'gray' }, grid: { color: '#eee' } }, x: { ticks: { color: 'gray' } } } : {} } }); }
        
        function populateFilters() { const catSel = document.getElementById('filter-session-cat'); const spkSel = document.getElementById('filter-session-speaker'); const currentCat = catSel.value; const currentSpk = spkSel.value; catSel.innerHTML = '<option value="all">Todas Trayectorias</option>'; spkSel.innerHTML = '<option value="all">Todos Ponentes</option>'; Object.values(categoriesDB).forEach(c => catSel.innerHTML += `<option value="${c.id}">${c.name}</option>`); const speakers = [...new Set(sessions.map(s => s.speaker))].sort(); speakers.forEach(sp => spkSel.innerHTML += `<option value="${sp}">${sp}</option>`); if(currentCat) catSel.value = currentCat; if(currentSpk) spkSel.value = currentSpk; }
        window.renderAdminSessions = function() { const tbody = document.getElementById('admin-sessions-table-body'); const search = document.getElementById('search-sessions').value.toLowerCase(); const filterCat = document.getElementById('filter-session-cat').value; const filterSpk = document.getElementById('filter-session-speaker').value; tbody.innerHTML = ''; const sessionCounts = {}; Object.values(usersDB).forEach(u => u.verifiedSessions.forEach(sid => sessionCounts[sid] = (sessionCounts[sid]||0)+1)); const filtered = sessions.filter(s => { const matchSearch = s.title.toLowerCase().includes(search); const matchCat = filterCat === 'all' || s.category === filterCat; const matchSpk = filterSpk === 'all' || s.speaker === filterSpk; return matchSearch && matchCat && matchSpk; }); const paged = paginate(filtered, currentPage.sessions); paged.items.forEach(s => { const cat = categoriesDB[s.category] || {name: s.category}; const rating = s.ratingAvg ? `⭐ ${s.ratingAvg.toFixed(1)}` : '-'; tbody.innerHTML += `<tr class="hover:bg-gray-50 border-b border-gray-100"><td class="p-3 text-gray-800 font-bold">${s.title}</td><td class="p-3 text-gray-500 text-xs">${cat.name}</td><td class="p-3 text-gray-500 text-xs">${s.speaker}</td><td class="p-3 text-gray-500 text-center text-xs">${s.durationMinutes} min</td><td class="p-3 text-center text-green-600 font-bold">${sessionCounts[s.id] || 0}</td><td class="p-3 text-center text-yellow-500 text-xs">${rating}</td><td class="p-3 text-center"><button onclick="openSessionEditor(${s.id})" class="text-blue-600 mr-2"><i class="fas fa-edit"></i></button><button onclick="deleteSession(${s.id})" class="text-red-500"><i class="fas fa-trash"></i></button></td></tr>`; }); renderPagination('sessions', paged.total, paged.current); };
        
        window.openSessionEditor = function(id = null) { 
            const modal = document.getElementById('session-editor-modal'); 
            const selectCat = document.getElementById('edit-category'); 
            const selectType = document.getElementById('edit-type'); 
            selectCat.innerHTML = ""; 
            Object.values(categoriesDB).forEach(c => selectCat.innerHTML += `<option value="${c.id}">${c.name}</option>`); 
            selectType.innerHTML = ""; 
            Object.values(sessionTypesDB).forEach(t => selectType.innerHTML += `<option value="${t.id}">${t.name}</option>`); 
            
            if(id) { 
                const s = sessions.find(x => x.id === id); 
                document.getElementById('editor-modal-title').innerText = "Editar Sesión"; 
                document.getElementById('edit-id').value = s.id; 
                document.getElementById('edit-title').value = s.title; 
                document.getElementById('edit-desc').value = s.desc; 
                document.getElementById('edit-speaker').value = s.speaker; 
                document.getElementById('edit-category').value = s.category; 
                document.getElementById('edit-type').value = s.typeId || (Object.keys(sessionTypesDB)[0] || ""); 
                document.getElementById('edit-link').value = s.link; 
                document.getElementById('edit-recording-link').value = s.recordingLink || ""; 
                document.getElementById('edit-gcal').value = s.gcal || ""; 
                
                if (s.startTime) { 
                    const d = new Date(s.startTime);
                    const year = d.getFullYear();
                    const month = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    const hours = String(d.getHours()).padStart(2, '0');
                    const mins = String(d.getMinutes()).padStart(2, '0');
                    document.getElementById('edit-date-day').value = `${year}-${month}-${day}`; 
                    document.getElementById('edit-date-time').value = `${hours}:${mins}`;
                }
                
                document.getElementById('edit-duration').value = s.durationMinutes; 
                document.getElementById('edit-image').value = s.image; 
            } else { 
                document.getElementById('editor-modal-title').innerText = "Nueva Sesión"; 
                document.getElementById('edit-id').value = ""; 
                document.getElementById('edit-title').value = ""; 
                document.getElementById('edit-date-day').value = ""; 
                document.getElementById('edit-date-time').value = ""; 
                document.getElementById('edit-recording-link').value = ""; 
                document.getElementById('edit-gcal').value = ""; 
            } 
            modal.classList.remove('hidden'); 
        };

        window.saveSessionForm = async function() { 
            const newId = parseInt(document.getElementById('edit-id').value) || Date.now(); 
            const dateDay = document.getElementById('edit-date-day').value; 
            const dateTime = document.getElementById('edit-date-time').value; 
            if(!dateDay || !dateTime) return Swal.fire("Error", "Fecha y hora requeridas", "error"); 
            const d = new Date(`${dateDay}T${dateTime}`); 
            const isoTime = d.toISOString(); 
            const recLink = window.getEmbedUrl(document.getElementById('edit-recording-link').value);
            
            await window.fb.setDoc(window.fb.doc(window.db, "sessions", newId.toString()), { 
                title: document.getElementById('edit-title').value, 
                desc: document.getElementById('edit-desc').value, 
                speaker: document.getElementById('edit-speaker').value, 
                category: document.getElementById('edit-category').value, 
                typeId: document.getElementById('edit-type').value, 
                link: document.getElementById('edit-link').value, 
                recordingLink: recLink, 
                gcal: document.getElementById('edit-gcal').value || "", 
                startTime: isoTime, 
                durationMinutes: parseInt(document.getElementById('edit-duration').value), 
                image: document.getElementById('edit-image').value, 
                featured: false 
            }, {merge: true}); 
            document.getElementById('session-editor-modal').classList.add('hidden'); 
            Swal.fire("Guardado", "Sesión actualizada en la nube.", "success"); 
        };

        // SECTIONS (VISIBILITY)
        window.renderAdminSections = function() {
            const tbody = document.getElementById('admin-sections-table-body');
            tbody.innerHTML = "";
            Object.values(sessionTypesDB).forEach(t => {
                const eyeClass = t.enabled !== false ? "text-green-500" : "text-gray-500";
                tbody.innerHTML += `
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="p-3 text-gray-800">${t.name} <span class="text-gray-500 text-xs uppercase">${t.id}</span></td>
                        <td class="p-3 text-center text-xs text-gray-600">${t.enabled!==false ? 'Visible' : 'Oculto'}</td>
                        <td class="p-3 text-center">
                            <button onclick="toggleSectionVisibility('${t.id}', ${t.enabled!==false})" class="${eyeClass} mr-2"><i class="fas fa-eye"></i></button>
                            <button onclick="deleteSection('${t.id}')" class="text-red-500"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
            });
        };
        window.toggleSectionVisibility = async function(id, currentState) {
            await window.fb.updateDoc(window.fb.doc(window.db, "session_types", id), { enabled: !currentState });
        };
        window.openSectionEditor = function() { document.getElementById('section-editor-modal').classList.remove('hidden'); document.getElementById('sect-edit-key').value=""; document.getElementById('sect-edit-name').value=""; };
        window.saveSectionForm = async function() { const k = document.getElementById('sect-edit-key').value.trim().toLowerCase(); const n = document.getElementById('sect-edit-name').value; if(!k || !n) return; await window.fb.setDoc(window.fb.doc(window.db, "session_types", k), { id: k, name: n, enabled: true }); document.getElementById('section-editor-modal').classList.add('hidden'); };
        window.deleteSection = async function(id) { if(confirm("¿Eliminar sección?")) await window.fb.deleteDoc(window.fb.doc(window.db, "session_types", id)); };
        
        window.deleteSession = async function(id) { if(confirm("¿Borrar sesión?")) { await window.fb.deleteDoc(window.fb.doc(window.db, "sessions", id.toString())); renderAdminSessions(); } };
        window.renderAdminPathways = function() { const b=document.getElementById('admin-pathways-table-body'); b.innerHTML=''; Object.values(categoriesDB).forEach(c=>b.innerHTML+=`<tr class="border-b border-gray-100 hover:bg-gray-50"><td class="p-3 text-2xl text-center">${c.emoji}</td><td class="p-3 text-white font-bold">${c.name}</td><td class="p-3 text-gray-500">${c.badge}</td><td class="p-3 text-center text-blue-600 font-bold">${c.req}</td><td class="p-3 text-center"><button onclick="openPathwayEditor('${c.id}')" class="text-blue-500 mr-2"><i class="fas fa-edit"></i></button><button onclick="deletePathway('${c.id}')" class="text-red-500"><i class="fas fa-trash"></i></button></td></tr>`); };
        window.openPathwayEditor = function(id = null) { const m = document.getElementById('pathway-editor-modal'); document.getElementById('path-edit-id').value = id || 'new'; document.getElementById('path-edit-key').disabled = !!id; if(id) { const c = categoriesDB[id]; document.getElementById('path-edit-key').value = c.id; document.getElementById('path-edit-name').value = c.name; document.getElementById('path-edit-badge').value = c.badge; document.getElementById('path-edit-emoji').value = c.emoji; document.getElementById('path-edit-req').value = c.req; } else { document.getElementById('path-edit-key').value = ""; document.getElementById('path-edit-name').value = ""; document.getElementById('path-edit-badge').value = ""; document.getElementById('path-edit-emoji').value = "🎓"; document.getElementById('path-edit-req').value = 3; } m.classList.remove('hidden'); };
        window.savePathwayForm = async function() { const k=document.getElementById('path-edit-key').value.trim().toLowerCase(); await window.fb.setDoc(window.fb.doc(window.db,"categories",k),{id:k, name:document.getElementById('path-edit-name').value, badge:document.getElementById('path-edit-badge').value, emoji:document.getElementById('path-edit-emoji').value, req:parseInt(document.getElementById('path-edit-req').value)}); document.getElementById('pathway-editor-modal').classList.add('hidden'); };
        window.deletePathway = async function(id) { if(confirm("¿Borrar?")) await window.fb.deleteDoc(window.fb.doc(window.db, "categories", id)); };
        
        window.renderAdminUsers = function() { const b=document.getElementById('admin-users-table-body'); b.innerHTML=''; let u=Object.values(usersDB); const p=paginate(u, currentPage.users); p.items.forEach(x=>b.innerHTML+=`<tr class="border-b border-gray-100 hover:bg-gray-50"><td class="p-3 text-gray-800">${x.id}</td><td class="p-3 text-center text-gray-500">${x.verifiedSessions.length}</td><td class="p-3 text-center">${x.certificates.length}</td><td class="p-3 text-center"><button onclick="openUserEditor('${x.id}')" class="text-blue-500 mr-2"><i class="fas fa-edit"></i></button><button onclick="deleteUser('${x.id}')" class="text-red-500"><i class="fas fa-trash"></i></button></td></tr>`); renderPagination('users',p.total,p.current); };
        window.openUserEditor = function(id) { const user = usersDB[id]; document.getElementById('student-edit-id').value = id; document.getElementById('student-edit-display-id').innerText = id; document.getElementById('student-edit-pass').value = ""; document.getElementById('student-editor-modal').classList.remove('hidden'); };
        window.saveUserForm = async function() { const id = document.getElementById('student-edit-id').value; const pass = document.getElementById('student-edit-pass').value.trim(); if(pass) { await window.fb.updateDoc(window.fb.doc(window.db, "students", id), { password: pass }); Swal.fire("Éxito", "Contraseña actualizada", "success"); } document.getElementById('student-editor-modal').classList.add('hidden'); };
        window.addUserManual = function() { Swal.fire({ input: 'text', title: 'Matrícula' }).then(async r => { if(r.value) { const id=r.value.toUpperCase().trim(); if(usersDB[id]) return; await window.fb.setDoc(window.fb.doc(window.db, "students", id), {id:id, verifiedSessions:[], certificates:[], favorites:[], lastAccess:"Nunca"}); usersDB[id]={ id: id, verifiedSessions:[], certificates:[], favorites:[], lastAccess:"Nunca" }; renderAdminUsers(); } }); };
        window.deleteUser = async function(uid) { if(confirm("¿Borrar?")) { await window.fb.deleteDoc(window.fb.doc(window.db,"students",uid)); delete usersDB[uid]; renderAdminUsers(); } };
        window.processAttendanceImport = async function() { const t=document.getElementById('import-text-area').value; const s=parseInt(document.getElementById('import-session-select').value); if(!s) return; const l=t.split(/[\n,]+/).map(x=>x.trim().toUpperCase()).filter(x=>x); let c=0; for(const id of l){ let u=usersDB[id]||{id:id,verifiedSessions:[],certificates:[],favorites:[],ratings:{}}; if(!u.verifiedSessions.includes(s)){ u.verifiedSessions.push(s); await window.fb.setDoc(window.fb.doc(window.db,"students",id),u); c++; } } Swal.fire("Ok",`${c} procesados`,"success"); };
        window.assignCertificateManual = async function() { const id=document.getElementById('cert-manual-id').value; const p=document.getElementById('cert-manual-pathway').value; const l=document.getElementById('cert-manual-link').value; if(!id)return; let u=usersDB[id]||{id:id,verifiedSessions:[],certificates:[],favorites:[],ratings:{}}; u.certificates=u.certificates.filter(c=>c.pathway!==p); u.certificates.push({pathway:p, link:l, accessed:false}); await window.fb.setDoc(window.fb.doc(window.db,"students",id),u); Swal.fire("Ok","Asignado","success"); };
        
        function paginate(items, page) { const start=(page-1)*ITEMS_PER_PAGE; return { current: page, total: Math.ceil(items.length/ITEMS_PER_PAGE), items: items.slice(start, start+ITEMS_PER_PAGE) }; }
        function renderPagination(type, total, current) { const c=document.getElementById(`pagination-${type}`); c.innerHTML=""; for(let i=1; i<=total; i++) { const b=document.createElement('button'); b.innerText=i; b.className=`pagination-btn ${i===current?'active':''}`; b.onclick=()=>{currentPage[type]=i; showAdminTab(type==='certs'?'certificates':type);}; c.appendChild(b); } }
        window.downloadUsersCSV = function() { downloadCSV(Object.values(usersDB).map(u => ({ Matrícula: u.id, Asistencias: u.verifiedSessions.length })), 'Alumnos.csv'); };
        window.exportSessionAttendanceCSV = function() { if(!currentAttendanceSessionId) return; const atts = Object.values(usersDB).filter(u => u.verifiedSessions.includes(currentAttendanceSessionId)); const s = sessions.find(x => x.id === currentAttendanceSessionId); downloadCSV(atts.map(u => ({ Matrícula: u.id, Sesión: s.title })), `Asistencias_${s.title}.csv`); };
        window.exportCertificatesCSV = function() { let data = []; Object.values(usersDB).forEach(u => { if(u.certificates) u.certificates.forEach(c => data.push({ Matrícula: u.id, Trayectoria: c.pathway, Enlace: c.link })); }); downloadCSV(data, 'Constancias.csv'); };
        function downloadCSV(data, filename) { if(!data.length) return Swal.fire("Info", "Vacío", "info"); const keys = Object.keys(data[0]); const csv = [keys.join(','), ...data.map(r => keys.map(k => `"${r[k]}"`).join(','))].join('\n'); const blob = new Blob([csv], { type: 'text/csv' }); const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = filename; document.body.appendChild(link); link.click(); document.body.removeChild(link); }
        window.populateCertPathways = function() { const s=document.getElementById('cert-manual-pathway'); s.innerHTML=''; Object.values(categoriesDB).forEach(c=>s.innerHTML+=`<option value="${c.id}">${c.name}</option>`); };
        window.renderAdminCertificates = function() { const b=document.getElementById('admin-certs-table-body'); b.innerHTML=''; let flat=[]; Object.values(usersDB).forEach(u=>{if(u.certificates)u.certificates.forEach(c=>flat.push({...c,uid:u.id}))}); const p=paginate(flat,currentPage.certs); p.items.forEach(c=>b.innerHTML+=`<tr class="border-b border-gray-100 hover:bg-gray-50"><td class="p-3 text-gray-800">${c.uid}</td><td class="p-3 text-gray-500 text-xs">${categoriesDB[c.pathway]?.name}</td><td class="p-3 text-blue-500 text-xs underline cursor-pointer">Link</td><td class="p-3 text-right"></td></tr>`); renderPagination('certs',p.total,p.current); };
        window.filterImportSessions = function() { const s=document.getElementById('import-session-select'); s.innerHTML=""; sessions.forEach(x=>s.innerHTML+=`<option value="${x.id}">${x.title}</option>`); window.renderSessionAttendanceTable(); };
        window.renderSessionAttendanceTable = function() { const id=parseInt(document.getElementById('import-session-select').value); const b=document.getElementById('admin-attendance-table-body'); b.innerHTML=""; const atts=Object.values(usersDB).filter(u=>u.verifiedSessions.includes(id)); atts.forEach(u=>b.innerHTML+=`<tr class="border-b border-gray-100"><td class="p-3 text-gray-800">${u.id}</td><td class="p-3 text-green-500 text-xs">Ok</td><td class="p-3 text-right"></td></tr>`); };
        function setupNavbarScroll() { const n = document.getElementById('navbar'); window.addEventListener('scroll', () => { if(window.scrollY>50) { n.classList.add('shadow-md'); } else { n.classList.remove('shadow-md'); } }); }
    </script>
</body>
</html>
